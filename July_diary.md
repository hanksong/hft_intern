# July 4th

任何币的收益是：

$$
PnL = (amount_t - amount_0) \times price_t
$$

对冲目标不是价值不变，是（潜在的）币数量不变
两种情况有别：

![image](https://huobiglobal.zendesk.com/hc/article_attachments/900005644783/APP___-_.PNG)

永续合约PnL的计算：https://huobiglobal.zendesk.com/hc/en-us/articles/900000728106-What-is-calculation-rule-for-closing-profit-after-settlement-

---

## 币本位合约对冲

1. 使用和池子比例相同的合约数量
2. long头寸

### case1

1. 假设GLP池含有（30000\$U + 30000\$BTC) , 此时BTC价格为\$30000, GLP价格为1\$
2. BTC价格变为\$31000 , GLP池子即(30000\$U + 31000\$BTC) , GLP 价格变为$61000/60000 = 1.017\

$$


$$

1. 显然，我一开始如果存入1BTC，换得30000GLP，最终只能换出

$$
\frac{30000 * 1.0167}{31000} = 0.9838(BTC)
$$

购买GLP和出售GLP后，BTC数量减少了。

1. 如果我使用了币本位合约，我一开始用0.5个BTC的long合约对冲，此时我的合约PnL是

$$
(1/30000 - 1/ 31000) \times 0.5 \times 30000 = 0.0161(BTC)
$$

正好弥补上一步中BTC的亏损，而保证金占用(全额)则为0.5个BTC

### case2

1. 仍保持前GLP池，假设BTC价格跌到\$29000，此时GLP池子是（\$30000 + \$29000）GLP价格为\$59000/60000 = 0.9833\$
2. 我一开始存入了1BTC，得到30000GLP，最终换出的BTC为

$$
\frac{30000\times 0.9833}{29000} = 1.0172(BTC)
$$

1. 如果我使用了币本位合约，我一开始持有0.5个BTC的long头寸，此时我的合约PnL为

$$
（1/30000 - 1/29000）\times 0.5 \times 30000 = -0.0172(BTC)
$$

---

## U本位合约

1. 使用和池子比例相同的合约数量
2. short头寸

### case1

1. 同样假设5050的比例，BTC价格有\$30000涨到\$31000，此时GLP池子是（\$30000 + \$31000）GLP价格为\$61000/60000 = 1.0167\$
2. 我一开始存入30000usdt，得到30000GLP，最终换出的usdt为

$$
30000\times 1.0167= 30500(usdt)
$$

3. 如果我使用了U本位合约，我一开始持有$15000(相当于0.5个btc)的short头寸，此时我的合约PnL为

$$
(30000-31000) * 0.5 = -500(usdt)
$$

### case2

1. 同样假设5050的比例，BTC价格有\$30000跌到\$29000，此时GLP池子是（\$30000 + \$29000）GLP价格为\$59000/60000 = 0.9833\$
2. 我一开始存入30000usdt，得到30000GLP，最终换出的usdt为

$$
30000\times 0.9833 = 29500(usdt)
$$

3. 如果我使用了U本位合约，我一开始持有$15000(相当于0.5个btc)的short头寸，此时我的合约PnL为

$$
(30000 - 29000) * 0.5 = 500(usdt)
$$

---

结论

* 用币买glp，此时需要保证币数量不变，需要使用币本位合约。
* 用u买glp，此时需要用u本位合约。
* 现货的case并不能保证币数量不变，只能保证价值不变。
  * 举例，借来0.5btc价值3w卖出，价格上涨到31000时，PnL = - 500，而gmx方面的btc只剩下0.9838。但是因为0.9838 * 31000 = 30500，所以总价值没变，但是btc少了。
  * 从另一个思路看：要归还0.5个btc需要15500去买btc，最终剩下15000 + 30500 - 15500 = 30000元。即btc减少，总价值没变。

## show case:

- GLP 持仓个数；
- GLP价格；eth价格；
- 实时的可换回的eth数量
- 合约PnL，以u或eth计；
- dividend

failed examples：
umami必须要做空，做空要不断平衡，平衡手续费umami用的第三方平台开销很大。

gamma neutral

# July 6th

Uni回测报告撰写中发现数据源不干净，换了回测区间重新测量，等回测结果后填入报告即可。

****既然Uni的对冲目标是eth数量稳定，那么用币本位合约，当价格上涨时Uni的eth减少，而合约同时获得正收益（eth结算）控制对冲比率是否可以更好完成任务？？****

## 合约盈亏和UniLP的dx模拟

当币价偏离初始值时，UniLP的币数量会变化，而合约也会有实时的PnL，模拟如下：

### case1 币本位合约

![1688634801426](image/diary/1688634801426.png)

### case2 u本位合约

![1688634894418](image/diary/1688634894418.png)

# todo

## GMX

* 多种对冲方式，现货 期货 多币种权重变化 ； 风险控制（仓位
* 等待同步。。。

## Uni

* 现货，完善模型，增加参数或者丰富模型，参考现有案例
* 期货，换成期货对冲，加上仓位控制

  * **Nomination 如何确定？**

  1. 按照爆仓和remove对应
  2. 不希望爆仓。
* 期权，调研（看docs）

---

# July 11th

## Uni -hanliang

期货对冲：

1. 期货对冲的思路和现货有区别
2. 希望两个币的数量都稳定，价格上升时，eth减少&usdt增加，希望有一个产品能够在价格上升时给我eth和拿走usdt。
3. 币本位long + u本位short。Nomination和加入的区间与资金量关联。比如：作为LP提供了25eth，区间为3%，那么当价格浮动3%时，合约的pnl应为±25eth。（margin太多or倍数太高），因为UniV3Lp天然有杠杆，增加margin不能解决问题。
   * 扩大Uni区间

# 损益分析

Uniswap的币变动由以下公式给出：

$$
dx = liq \times (\frac{1}{\sqrt{p_1}} - \frac{1}{\sqrt{p_0}})
$$

同时，合约的损益为：

$$
PnL = (\frac{1}{p_0} - \frac{1}{p_1}) * n_{value}
$$

$n_{value}$ 是合约名义价值，即当杠杆为2x，nomination为1000usdt时，合约实际的名义价值为2 * 1000 usdt。

因此要使得合约的损益对冲，需要满足：

$$
totalPnL = Pnl + dx = liq \times (\frac{1}{\sqrt{p_1}} - \frac{1}{\sqrt{p_0}}) + (\frac{1}{p_0} - \frac{1}{p_1}) * n_{value}
$$

**选取合适的$n_{value}$使得$totalPnL$方差最小.**

report：

* 对冲原理 ：合约逻辑，数理模型
* 回测结果，case分析，优化

# July 4th

任何币的收益是：

$$
PnL = (amount_t - amount_0) \times price_t
$$

对冲目标不是价值不变，是（潜在的）币数量不变
两种情况有别：

![image](https://huobiglobal.zendesk.com/hc/article_attachments/900005644783/APP___-_.PNG)

永续合约PnL的计算：https://huobiglobal.zendesk.com/hc/en-us/articles/900000728106-What-is-calculation-rule-for-closing-profit-after-settlement-

---

## 币本位合约对冲

1. 使用和池子比例相同的合约数量
2. long头寸

### case1

1. 假设GLP池含有（30000\$U + 30000\$BTC) , 此时BTC价格为\$30000, GLP价格为1\$
2. BTC价格变为\$31000 , GLP池子即(30000\$U + 31000\$BTC) , GLP 价格变为$61000/60000 = 1.017\

$$


$$

1. 显然，我一开始如果存入1BTC，换得30000GLP，最终只能换出

$$
\frac{30000 * 1.0167}{31000} = 0.9838(BTC)
$$

购买GLP和出售GLP后，BTC数量减少了。

1. 如果我使用了币本位合约，我一开始用0.5个BTC的long合约对冲，此时我的合约PnL是

$$
(1/30000 - 1/ 31000) \times 0.5 \times 30000 = 0.0161(BTC)
$$

正好弥补上一步中BTC的亏损，而保证金占用(全额)则为0.5个BTC

### case2

1. 仍保持前GLP池，假设BTC价格跌到\$29000，此时GLP池子是（\$30000 + \$29000）GLP价格为\$59000/60000 = 0.9833\$
2. 我一开始存入了1BTC，得到30000GLP，最终换出的BTC为

$$
\frac{30000\times 0.9833}{29000} = 1.0172(BTC)
$$

1. 如果我使用了币本位合约，我一开始持有0.5个BTC的long头寸，此时我的合约PnL为

$$
（1/30000 - 1/29000）\times 0.5 \times 30000 = -0.0172(BTC)
$$

---

## U本位合约

1. 使用和池子比例相同的合约数量
2. short头寸

### case1

1. 同样假设5050的比例，BTC价格有\$30000涨到\$31000，此时GLP池子是（\$30000 + \$31000）GLP价格为\$61000/60000 = 1.0167\$
2. 我一开始存入30000usdt，得到30000GLP，最终换出的usdt为

$$
30000\times 1.0167= 30500(usdt)
$$

3. 如果我使用了U本位合约，我一开始持有$15000(相当于0.5个btc)的short头寸，此时我的合约PnL为

$$
(30000-31000) * 0.5 = -500(usdt)
$$

### case2

1. 同样假设5050的比例，BTC价格有\$30000跌到\$29000，此时GLP池子是（\$30000 + \$29000）GLP价格为\$59000/60000 = 0.9833\$
2. 我一开始存入30000usdt，得到30000GLP，最终换出的usdt为

$$
30000\times 0.9833 = 29500(usdt)
$$

3. 如果我使用了U本位合约，我一开始持有$15000(相当于0.5个btc)的short头寸，此时我的合约PnL为

$$
(30000 - 29000) * 0.5 = 500(usdt)
$$

---

结论

* 用币买glp，此时需要保证币数量不变，需要使用币本位合约。
* 用u买glp，此时需要用u本位合约。
* 现货的case并不能保证币数量不变，只能保证价值不变。
  * 举例，借来0.5btc价值3w卖出，价格上涨到31000时，PnL = - 500，而gmx方面的btc只剩下0.9838。但是因为0.9838 * 31000 = 30500，所以总价值没变，但是btc少了。
  * 从另一个思路看：要归还0.5个btc需要15500去买btc，最终剩下15000 + 30500 - 15500 = 30000元。即btc减少，总价值没变。

## show case:

- GLP 持仓个数；
- GLP价格；eth价格；
- 实时的可换回的eth数量
- 合约PnL，以u或eth计；
- dividend

failed examples：
umami必须要做空，做空要不断平衡，平衡手续费umami用的第三方平台开销很大。

gamma neutral

# July 6th

Uni回测报告撰写中发现数据源不干净，换了回测区间重新测量，等回测结果后填入报告即可。

****既然Uni的对冲目标是eth数量稳定，那么用币本位合约，当价格上涨时Uni的eth减少，而合约同时获得正收益（eth结算）控制对冲比率是否可以更好完成任务？？****

## 合约盈亏和UniLP的dx模拟

当币价偏离初始值时，UniLP的币数量会变化，而合约也会有实时的PnL，模拟如下：

### case1 币本位合约

![1688634801426](image/diary/1688634801426.png)

### case2 u本位合约

![1688634894418](image/diary/1688634894418.png)

# todo

## GMX

* 多种对冲方式，现货 期货 多币种权重变化 ； 风险控制（仓位
* 等待同步。。。

## Uni

* 现货，完善模型，增加参数或者丰富模型，参考现有案例
* 期货，换成期货对冲，加上仓位控制

  * **Nomination 如何确定？**

  1. 按照爆仓和remove对应
  2. 不希望爆仓。
* 期权，调研（看docs）

---

# July 11th

## Uni -hanliang

期货对冲：

1. 期货对冲的思路和现货有区别
2. 希望两个币的数量都稳定，价格上升时，eth减少&usdt增加，希望有一个产品能够在价格上升时给我eth和拿走usdt。
3. 币本位long + u本位short。Nomination和加入的区间与资金量关联。比如：作为LP提供了25eth，区间为3%，那么当价格浮动3%时，合约的pnl应为±25eth。（margin太多or倍数太高），因为UniV3Lp天然有杠杆，增加margin不能解决问题。
   * 扩大Uni区间

# 损益分析

Uniswap的币变动由以下公式给出：

$$
dx = liq \times (\frac{1}{\sqrt{p_1}} - \frac{1}{\sqrt{p_0}})
$$

同时，合约的损益为：

$$
PnL = (\frac{1}{p_0} - \frac{1}{p_1}) * n_{value}
$$

$n_{value}$ 是合约名义价值，即当杠杆为2x，nomination为1000usdt时，合约实际的名义价值为2 * 1000 usdt。

因此要使得合约的损益对冲，需要满足：

$$
totalPnL = Pnl + dx = liq \times (\frac{1}{\sqrt{p_1}} - \frac{1}{\sqrt{p_0}}) + (\frac{1}{p_0} - \frac{1}{p_1}) * n_{value}
$$

**选取合适的$n_{value}$使得$totalPnL$方差最小.**

report：

* 对冲原理 ：合约逻辑，数理模型
* 回测结果，case分析，优化

BI CONTRACTS

$$
a_0 = liq\sqrt{p_0} / 2
$$

U CONTRACTS

$$
a_1 = a_0
$$

**如果我们忽略Divident，将UniLP的头寸变化量记为净损益$dx，dy$，可以看到二者的delta是关于$p^{-{0.5}}$的函数，而期货的delta是关于对冲数量$a$的函数。只有动态调整$a$，才能达到delta_hedge的目的。
此时, 可能会涉及到手续费和总损失（dx + dy + bipnl + upnl）之间的抉择。**

eth_usdt_uswap
eth_usd_cswap

# July 24

* [X] 否定了单合约对冲的方式，因为单合约必须选对冲方向，难以实现。
* [X] 双合约对冲的report

1. 收益骤降070622~070701三小时，p_d下降1.5%，此时contract_pnl基本没变，损失主要由IL构成。
2. 20230713 14：00 - 20230713 15：45 三小时，此时contract_pnl下跌近1500，是造成损失的主要原因。亏损是由于这时候两个pnl有差导致的。

结论：第一个pool中结余-2.2个eth，这2.2个eth当价格上升时会带来更大的亏损。这能够解释第二次突变。而第一次突变则由两种原因，前序结余的（-2.0）个eth在价格下降的时候带来亏损，同时IL增大导致进一步亏损。

按照模拟结果看，每次撤出损失的大概是1200$ 大致符合回测结果。

# July25

## 如何合并pool？

**假设价格最终上涨 : 2000 -> 2050**

1. 提供流动性 eth = 23.7948 & u = 50000
2. remove了，eth = 11.6797 & u =74531.1198
3. bi_pnl = +12.0407 & u_pnl = -24058.4929

| 变化量    | eth      | usdt        |
| --------- | -------- | ----------- |
| dex       | -12.1150 | +24531.1198 |
| perpetual | +12.0407 | -24683.4929 |
| sum       | -0.0743  | -152.3730   |

$$
loss = -0.0743 * 2050 - 152.3730= -304.7460
$$

4. 当价格为2050时，我add需要 eth = 23.2144 & usdt = 50000 ； 其中usdt缺少-152.3730个，而此时手上有11.6797 + 11.7358 =23.7204个eth，~~除去加入的eth还结余0.5060个eth。即eth足够补齐下次add的缺口。~~

---

**假设价格最终下跌： 2000 -> 1950**

1. 提供流动性 ： eth = 23.7948 & u = 50000
2. remove了， eth = 36.3728 & u = 25160.2761
3. bi_pnl = -12.6582& u_pnl = 24683.4929

| 变化量    | col2     | col3        |
| --------- | -------- | ----------- |
| dex       | +12.5780 | -24839.7238 |
| perpetual | -12.6582 | 24683.4929  |
| sum       | -0.0801  | -156.2308   |

$$
loss = -0.0801* 1950 - 156.2308 = -312.4617
$$

4. 当价格为1950时，我add需要 eth = 24.4049 & usdt = 50000.0； 其中usdt结余-156个，而此时手上有36.3728-12.6582= 23.7146 个eth，~~需要补充 156 个usdt 和 0.6902 个eth。~~

---

***价格上升，再加入的e变少了，因此即便e下降也足够加入，但是价格下降时，本身需要加入的eth就更多，也就不足以弥补u的缺口***

~~从哪儿获得u和e？~~

- ~~从外部获得，则相当于额外投入了资金，总价值不变时，投入资金计入成本。~~
- ~~从div获得~~
  - ~~直接用div分到的eth补 		。~~
  - ~~用div分到的u换成e补		。~~

---

# 为什么要用期货

1. 现货是等敞口出现再对冲，是用实现盈亏对冲浮动盈亏； 期货是提前对冲，用浮盈对冲浮盈，避免频繁调仓和无效对冲。
2. 期货交易量更大。

# July 26


验证 ： 

永续对冲策略等效于以下策略：
在任何remove的时候，将敞口在现货市场买入或卖出来配平。

永续对冲（加入theta）等效于以下策略：

在任何theta突破的时候，现货平敞口。




# July 27
  
- uni
  - 配置“$\sigma $”控制流动性，配置$\theta $控制增减仓位交易时机，产出cex永续对冲的数据（7月）
  - 对比现货对冲的结果，分析报告









